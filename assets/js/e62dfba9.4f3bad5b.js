"use strict";(self.webpackChunkdocusaurus_blog_with_search=self.webpackChunkdocusaurus_blog_with_search||[]).push([[3637],{3905:(e,t,o)=>{o.d(t,{Zo:()=>u,kt:()=>d});var n=o(7294);function a(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function r(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,n)}return o}function i(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?r(Object(o),!0).forEach((function(t){a(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):r(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function s(e,t){if(null==e)return{};var o,n,a=function(e,t){if(null==e)return{};var o,n,a={},r=Object.keys(e);for(n=0;n<r.length;n++)o=r[n],t.indexOf(o)>=0||(a[o]=e[o]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)o=r[n],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(a[o]=e[o])}return a}var l=n.createContext({}),p=function(e){var t=n.useContext(l),o=t;return e&&(o="function"==typeof e?e(t):i(i({},t),e)),o},u=function(e){var t=p(e.components);return n.createElement(l.Provider,{value:t},e.children)},c="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var o=e.components,a=e.mdxType,r=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),c=p(o),h=a,d=c["".concat(l,".").concat(h)]||c[h]||m[h]||r;return o?n.createElement(d,i(i({ref:t},u),{},{components:o})):n.createElement(d,i({ref:t},u))}));function d(e,t){var o=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=o.length,i=new Array(r);i[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[c]="string"==typeof e?e:a,i[1]=s;for(var p=2;p<r;p++)i[p]=o[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,o)}h.displayName="MDXCreateElement"},4054:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>m,frontMatter:()=>r,metadata:()=>s,toc:()=>p});var n=o(7462),a=(o(7294),o(3905));const r={slug:"/2024-04-07-mono-repo-functions.md",canonical_url:"https://dfberry.github.io/blog/2024-04-07-mono-repo-functions.md",custom_edit_url:null,sidebar_label:"2024-04-07 Azure Functions in mono repos",title:"Deploy an Azure Functions app from a monorepo with a GitHub Action for Node.js",description:"Monorepos for Node.js are a unique challenge with Azure functions. Learn 2 tricks to successfully deploy.",published:!1,tags:["Azure","Azure Functions","Developer Experience","Deploy"],updated:"2024-04-07 00:00 PST"},i="Deploy an Azure Functions app from a monorepo with a GitHub Action for Node.js",s={permalink:"/2024-04-07-mono-repo-functions.md",source:"@site/blog/2024-04-07-mono-repo-functions.md",title:"Deploy an Azure Functions app from a monorepo with a GitHub Action for Node.js",description:"Monorepos for Node.js are a unique challenge with Azure functions. Learn 2 tricks to successfully deploy.",date:"2024-04-07T00:00:00.000Z",formattedDate:"April 7, 2024",tags:[{label:"Azure",permalink:"/tags/azure"},{label:"Azure Functions",permalink:"/tags/azure-functions"},{label:"Developer Experience",permalink:"/tags/developer-experience"},{label:"Deploy",permalink:"/tags/deploy"}],readingTime:3.815,hasTruncateMarker:!1,authors:[],frontMatter:{slug:"/2024-04-07-mono-repo-functions.md",canonical_url:"https://dfberry.github.io/blog/2024-04-07-mono-repo-functions.md",custom_edit_url:null,sidebar_label:"2024-04-07 Azure Functions in mono repos",title:"Deploy an Azure Functions app from a monorepo with a GitHub Action for Node.js",description:"Monorepos for Node.js are a unique challenge with Azure functions. Learn 2 tricks to successfully deploy.",published:!1,tags:["Azure","Azure Functions","Developer Experience","Deploy"],updated:"2024-04-07 00:00 PST"},prevItem:{title:"GitHub Account Cleanup: Audit, Archive & Remove Stale Repos",permalink:"/2025-12-30-github-account-clean.md"},nextItem:{title:"Examples of code includes for Dev.to",permalink:"/2024-04-06-code-includes.md"}},l={authorsImageUrls:[]},p=[{value:"Single versus monorepo repositories",id:"single-versus-monorepo-repositories",level:2},{value:"Monorepo repositories as a single source of truth",id:"monorepo-repositories-as-a-single-source-of-truth",level:2},{value:"Azure Functions apps with Visual Studio Code",id:"azure-functions-apps-with-visual-studio-code",level:2},{value:"GitHub actions workflow file for Azure Functions monorepo app",id:"github-actions-workflow-file-for-azure-functions-monorepo-app",level:2},{value:"Yaml",id:"yaml",level:2}],u={toc:p},c="wrapper";function m(e){let{components:t,...o}=e;return(0,a.kt)(c,(0,n.Z)({},u,o,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"Azure Functions apps can be locally deployed from Visual Studio Code using the Azure Functions extension or when you create the resource in the portal, you can configure deployment. These are straightforward when your app is the only thing in the repo but become a little more challenging in monorepos. "),(0,a.kt)("h2",{id:"single-versus-monorepo-repositories"},"Single versus monorepo repositories"),(0,a.kt)("p",null,"When you have a single function in a repo, the Azure Functions app is build and run from the root level package.json which is where hosting platforms look for those files. "),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"- package.json\n- package-lock.json\n- src\n    - functions\n        - hello-world.js\n")),(0,a.kt)("p",null,"In a monorepos, all these files are pushed down a level or two and there may or may not be a root-level package.json."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-text"},"- package.json\n- packages\n    - products\n        - package.json\n        - package-lock.json\n        - src\n            - functions\n                - product.js\n    - sales\n        - package.json\n        - package-lock.json\n        - src\n            - functions\n                - sales.js\n")),(0,a.kt)("p",null,"If there is a root-level package.json, it may control developer tooling across all packages. While you can deploy the entire repo to a hosting platform and configure which package is launched, this isn't necessary and may lead to problems. "),(0,a.kt)("h2",{id:"monorepo-repositories-as-a-single-source-of-truth"},"Monorepo repositories as a single source of truth"),(0,a.kt)("p",null,"Monorepo repositories allow you to collect all source code or at least all source code for a project into a single place. This is ideal for microservices or full-stack apps. There is an extra layer of team education and repository management in order to efficiently operationalize this type of repository. "),(0,a.kt)("p",null,"When starting the monorepo, you need to select the workspace management. I use npm workspaces but others exist. This requires a root-level package.json with the packages (source code projects) noted."),(0,a.kt)("p",null,"The syntax for npm workspaces allows you to select what is a package as well as what is not a package. "),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-json",metastring:"reference",reference:!0},"https://github.com/dfberry/dfberry-blog/blob/main/snippets/2024-04-07-functions-monorepo/package-workspaces.json\n")),(0,a.kt)("h2",{id:"azure-functions-apps-with-visual-studio-code"},"Azure Functions apps with Visual Studio Code"),(0,a.kt)("p",null,"When you create a Functions app with Visual Studio Code with the Azure Functions extension you can select it to be created at the root, or in a package. As part of that creation process, a ",(0,a.kt)("inlineCode",{parentName:"p"},".vscode")," folder is created with files to help find and debug the app. "),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"extensions.json: all Visual Studio Code extensions"),(0,a.kt)("li",{parentName:"ul"},"launch.json: debug"),(0,a.kt)("li",{parentName:"ul"},"settings.json: settings for extensions"),(0,a.kt)("li",{parentName:"ul"},"tasks.json: tasks for launch.json")),(0,a.kt)("p",null,"The ",(0,a.kt)("strong",{parentName:"p"},"settings.json")," includes ",(0,a.kt)("inlineCode",{parentName:"p"},"azureFunctions.deploySubpath")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"azureFunctions.projectSubpath")," properties which tells Azure Functions where to find the source code. For a monorepo, the value of these settings may depend on the version of the extension you use. "),(0,a.kt)("p",null,"As of March 2024, setting the exact path has worked for me, such as ",(0,a.kt)("inlineCode",{parentName:"p"},"packages/sales/"),". "),(0,a.kt)("p",null,"If you don't set the correct path for these values, the correct package may not be used with the extension or the hosting platform won't find the correct package.json to launch the Node.js Functions app. "),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"During development: set the ",(0,a.kt)("inlineCode",{parentName:"li"},"azureFunctions.projectSubpath")," to the single package path you are developing."),(0,a.kt)("li",{parentName:"ul"},"During deployment: set the ",(0,a.kt)("inlineCode",{parentName:"li"},"azureFunctions.deploySubpath")," to the single package path so the hosting platform has the correct path to launch the app. ")),(0,a.kt)("h2",{id:"github-actions-workflow-file-for-azure-functions-monorepo-app"},"GitHub actions workflow file for Azure Functions monorepo app"),(0,a.kt)("p",null,"When you create a Azure Functions app in the Azure portal and configure the deployment, the default (and not editable) workflow file is built for a ",(0,a.kt)("strong",{parentName:"p"},"monorepo")," where the app's package.json is at the root of the repository."),(0,a.kt)("h2",{id:"yaml"},"Yaml"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yml",metastring:"reference",reference:!0},"https://github.com/dfberry/dfberry-blog/blob/main/snippets/2024-04-07-functions-monorepo/single-app-workflow.yml\n")),(0,a.kt)("p",null,"This worklow sets the ",(0,a.kt)("inlineCode",{parentName:"p"},"AZURE_FUNCTIONAPP_PACKAGE_PATH")," as the root of the project then pushes, ",(0,a.kt)("inlineCode",{parentName:"p"},"pushd './${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}'"),", into that path to build. The zip, ",(0,a.kt)("inlineCode",{parentName:"p"},"zip release.zip ./* -r"),", packages up everything as the root. To use a monorepo, these need to be altered. "),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Change the name of the workflow to indicate the package and project."),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-yml"},"name: Build & deploy Azure Function - sales\n"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Create a new global ",(0,a.kt)("inlineCode",{parentName:"p"},"env")," parameter that sets the package location for the subdirectory source code. "),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-yml"},"PACKAGE_PATH: 'packages/sales' \n"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Change the ",(0,a.kt)("inlineCode",{parentName:"p"},"Resolve Project Dependencies Using Npm")," to include the new environment variable."),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-yml"},"pushd './${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/${{ PACKAGE_PATH }}'\n")),(0,a.kt)("p",{parentName:"li"},"The ",(0,a.kt)("inlineCode",{parentName:"p"},"pushd")," commands moves the context into that sales subdirectory.")),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"Change the ",(0,a.kt)("inlineCode",{parentName:"p"},"Zip artifact for deployment")," to use ",(0,a.kt)("inlineCode",{parentName:"p"},"pushd")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"popd")," and include the new environment variable. The ",(0,a.kt)("inlineCode",{parentName:"p"},"popd")," command returns the context to the root of the project. "),(0,a.kt)("p",{parentName:"li"},"Using the ",(0,a.kt)("inlineCode",{parentName:"p"},"pushd")," command, change the location of the generated zip file to be in root directory. "),(0,a.kt)("p",{parentName:"li"},"The result is that the zip file's file structure looks like:"),(0,a.kt)("pre",{parentName:"li"},(0,a.kt)("code",{parentName:"pre",className:"language-text"},"- package.json\n- src\n    - functions\n        - sales.js\n\n"))),(0,a.kt)("li",{parentName:"ol"},(0,a.kt)("p",{parentName:"li"},"The final workflow file for a monorepo repository with an Azure functions package is:"))),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yml",metastring:"reference",reference:!0},"https://github.com/dfberry/dfberry-blog/blob/main/snippets/2024-04-07-functions-monorepo/mono-app-workflow.yml\n")))}m.isMDXComponent=!0}}]);